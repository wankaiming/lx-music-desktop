name: Build

on:
  push:
    branches:
      - master

env:
  IS_CI: 'true'

jobs:


  Windows:
    name: Windows
    runs-on: windows-latest
    # needs: CheckCode
    steps:
      - name: Check out git repository
        uses: actions/checkout@v4

      - name: Get npm cache directory
        shell: pwsh
        run: echo "NPM_CACHE=$(npm config get cache)" >> $env:GITHUB_ENV

      - name: Show Env
        run: echo "${{ env.NPM_CACHE }}"

      - name: Setup Node Env
        env:
          NPM_CACHE: ${{ env.NPM_CACHE }}
        uses: ./.github/actions/setup

      - name: Build src code
        run: |
          git status --porcelain
          npm run build

      - name: Release package
        run: |
          npm run publish:win:7z:x64
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BT_TOKEN: ${{ secrets.BT_TOKEN }}

      - name: Save node_modules and lock file
        uses: actions/upload-artifact@v4
        with:
          name: npm-dependencies
          path: |
                node_modules/
                package-lock.json
          retention-days: 7  # 可选，设置保留天数  

      - name: Build Package Setup x64
        run: npm run pack:win:setup:x64
      - name: Upload Artifact Setup x64
        uses: actions/upload-artifact@v4
        with:
          name: lx-music-desktop-x64-Setup
          path: build/*-x64-Setup.exe

      - name: Build Package 7z x64
        run: npm run pack:win:7z:x64
      - name: Upload Artifact 7z x64
        uses: actions/upload-artifact@v4
        with:
          name: lx-music-desktop-win_x64-green
          path: build/*win_x64-green.7z          

      - name: Generate file MD5
        run: |
          cd build
          Get-FileHash *.exe,*.7z -Algorithm MD5 | Format-List


  